<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChildTrack Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0d1b4c, #0d1b4c);
      color: white;
      min-height: 100vh;
      padding: 40px 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.3);
      max-width: 1000px;
    }
    table {
      margin-top: 20px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    th, td {
      color: white;
    }
    th {
      background-color: rgba(255, 255, 255, 0.15);
    }
    #qrInput {
      opacity: 0;
      position: absolute;
      pointer-events: none;
    }
    video, canvas {
      width: 100%;
      max-height: 200px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<div class="container text-white">
  <h1 class="text-center mb-4">ChildTrack Dashboard</h1>

  <div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
    <button class="btn btn-success fw-bold" onclick="focusScanner()">Scan QR for Attendance</button>
    <button class="btn btn-warning fw-bold" onclick="openModal()">Unregistered Guardian</button>
    <button class="btn btn-light fw-bold" onclick="downloadAttendance()">Download Attendance</button>
  </div>

  <input type="text" id="qrInput" oninput="handleScannerInput()" autofocus />

  <div class="row mb-3 g-2">
    <div class="col-md-8">
      <input type="text" id="searchInput" class="form-control" placeholder="Search..." onkeyup="filterTable()">
    </div>
    <div class="col-md-4">
      <select id="statusFilter" class="form-select" onchange="filterTable()">
        <option value="">All Statuses</option>
        <option value="Present">Present</option>
        <option value="Absent">Absent</option>
        <option value="Unregistered">Unregistered</option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-bordered" id="attendanceTable">
      <thead class="table-light text-dark">
        <tr>
          <th>LRN</th>
          <th>Student Name</th>
          <th>Parent Name</th>
          <th>Guardian Name</th>
          <th>Status</th>
          <th>Timestamp</th>
          <th>Photo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ✅ Audio -->
<audio id="successBeep" src="beep.mp3" preload="auto"></audio>

<!-- ✅ Modal -->
<div class="modal fade" id="unregisteredModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white p-4 rounded">
      <div class="modal-header border-0">
        <h5 class="modal-title">Unregistered Guardian Entry</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="modalStudent" class="form-control mb-2" placeholder="Student Name">
        <input type="text" id="modalGuardian" class="form-control mb-2" placeholder="Guardian Name">
        <select id="modalStatus" class="form-select mb-3">
          <option value="Present">Present</option>
          <option value="Absent">Absent</option>
        </select>

        <video id="video" autoplay playsinline></video>
        <button class="btn btn-sm btn-secondary mt-2" onclick="capturePhoto()">📸 Capture Photo</button>
        <canvas id="photoCanvas" class="mt-3 d-none"></canvas>
      </div>
      <div class="modal-footer border-0">
        <button class="btn btn-primary" onclick="submitUnregistered()">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let scanTimeout = null;
  let videoStream = null;

  function getCurrentTimestamp() {
    const now = new Date();
    const date = now.toISOString().split("T")[0];
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, "0");
    const seconds = now.getSeconds().toString().padStart(2, "0");
    const ampm = hours >= 12 ? "PM" : "AM";
    hours = hours % 12 || 12;
    return `${date} ${hours.toString().padStart(2, "0")}:${minutes}:${seconds} ${ampm}`;
  }

  function addRow(lrn, student, parent, guardian, status, timestamp, photoDataUrl = '') {
    const table = document.getElementById("attendanceTable").getElementsByTagName("tbody")[0];
    const row = table.insertRow();
    row.innerHTML = `
      <td>${lrn || "-"}</td>
      <td>${student}</td>
      <td>${parent || "-"}</td>
      <td>${guardian}</td>
      <td>${status}</td>
      <td>${timestamp}</td>
      <td>${photoDataUrl ? `<img src="${photoDataUrl}" width="60">` : '-'}</td>
    `;
  }

  function focusScanner() {
    const input = document.getElementById("qrInput");
    input.value = '';
    input.focus();
  }

  function filterTable() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const status = document.getElementById("statusFilter").value.toLowerCase();
    const rows = document.querySelectorAll("#attendanceTable tbody tr");

    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      const statusText = row.cells[4].innerText.toLowerCase();
      row.style.display = (text.includes(input) && (status === "" || statusText === status)) ? "" : "none";
    });
  }

  function downloadAttendance() {
    const rows = document.querySelectorAll("#attendanceTable tr");
    let csv = "";
    rows.forEach(row => {
      const cells = Array.from(row.cells).slice(0, 6).map(c => `"${c.textContent}"`).join(",");
      csv += cells + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Attendance.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  function sanitizeJSONString(str) {
    return str
      .trim()
      .replace(/^\uFEFF/, '') // Remove BOM
      .replace(/[“”]/g, '"')  // Replace smart quotes
      .replace(/\\?'/g, '"')  // Replace single quotes
      .replace(/([{,])\s*([a-zA-Z0-9_]+)\s*:/g, '$1"$2":') // Add quotes to keys
      .replace(/[\n\r\t\b\f]/g, '') // Remove control characters
      .replace(/[^\x20-\x7E]/g, ''); // Remove non-printable ASCII
  }

  function handleScannerInput() {
    const input = document.getElementById("qrInput");
    if (scanTimeout) clearTimeout(scanTimeout);

    scanTimeout = setTimeout(() => {
      let raw = input.value.trim();
      try {
        const clean = sanitizeJSONString(raw);
        const data = JSON.parse(clean);

        const { lrn, student, parent, guardian } = data;
        if (!lrn || !student || !parent || !guardian) throw new Error("Missing fields");

        const timestamp = getCurrentTimestamp();
        addRow(lrn, student, parent, guardian, "Present", timestamp);
        document.getElementById("successBeep").play();
      } catch (err) {
        console.error("Invalid QR content:", raw, err);
        alert("❌ Invalid QR Code content.");
      }

      input.value = '';
      filterTable();
    }, 300);
  }

  function openModal() {
    const modal = new bootstrap.Modal(document.getElementById('unregisteredModal'));
    modal.show();
    startCamera();
  }

  async function startCamera() {
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
      document.getElementById("video").srcObject = videoStream;
    } catch (e) {
      alert("Unable to access camera.");
    }
  }

  function capturePhoto() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("photoCanvas");
    const context = canvas.getContext("2d");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.classList.remove("d-none");
  }

  function submitUnregistered() {
    const student = document.getElementById("modalStudent").value.trim();
    const guardian = document.getElementById("modalGuardian").value.trim();
    const status = document.getElementById("modalStatus").value;
    const timestamp = getCurrentTimestamp();

    if (!student || !guardian) {
      alert("Please complete the form.");
      return;
    }

    const canvas = document.getElementById("photoCanvas");
    const photo = canvas.toDataURL("image/png");

    addRow("-", student, "-", guardian, status, timestamp, photo);
    document.getElementById("successBeep").play();

    // Stop camera
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
      videoStream = null;
    }

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('unregisteredModal')).hide();
  }

  window.onload = () => {
    document.getElementById("qrInput").focus();
  };
</script>

</body>
</html>